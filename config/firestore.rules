rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && (request.auth.token.role in ['admin', 'ADMIN', 'Admin']);
    }

    // acepta GeoPoint en field `location` o campos legacy `latitude`/`longitude`
    function hasValidLocation(obj) {
      return (
        (obj.location is map && (
          obj.location.latitude is number && obj.location.longitude is number
          || obj.location.lat is number && obj.location.lng is number
        ))
        || (obj.latitude is number && obj.longitude is number)
        || (obj.lat is number && obj.lng is number)
      );
    }

    // acepta Timestamp o ISO string legacy
    function isTimestampOrString(value) {
      return value is timestamp || value is string;
    }


    // Usuarios: lectura si eres el mismo usuario o si eres admin; crear/editar solo por el propio usuario
    match /users/{userId} {
      // Lectura: el dueño puede leer su doc; además permitimos admins mediante custom claim
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());

      // Crear solo por el propio usuario autenticado.
      // Permitir update/delete al propio usuario OR a un admin (custom claim).
      allow create: if isSignedIn() && request.auth.uid == userId
        && request.resource.data.email is string;

      allow update, delete: if isSignedIn() && (
        request.auth.uid == userId || isAdmin()
      )
      // Validaciones mínimas al actualizar/crear
      && (request.resource.data.email is string || !('email' in request.resource.data))
      && (request.resource.data.role is string || !('role' in request.resource.data))
      && (
        !request.resource.data.keys().hasAny(['createdAt']) ||
        isTimestampOrString(request.resource.data.createdAt)
      );
    }

    // Viajes (legacy): si existen, mantener reglas compatibles
    match /trips/{tripId} {
      allow create: if isSignedIn() && request.resource.data.passengerId is string;
      allow read, update, delete: if isSignedIn() && (
        (resource.data.passengerId == request.auth.uid) || (resource.data.driverId == request.auth.uid) || isAdmin()
      );
    }

    // Ubicaciones de conductores
    match /driverLocations/{driverId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && request.auth.uid == driverId
        && hasValidLocation(request.resource.data)
        && (request.resource.data.accuracy is number || !request.resource.data.keys().hasAny(['accuracy']))
        && (request.resource.data.isOnline is bool || !request.resource.data.keys().hasAny(['isOnline']))
        && (
          !request.resource.data.keys().hasAny(['timestamp']) ||
          isTimestampOrString(request.resource.data.timestamp)
        );
      allow delete: if isSignedIn() && (request.auth.uid == driverId || isAdmin());
    }

    // Pagos: solo propietario puede crear/leer/editar sus pagos (legacy)
    match /payments/{paymentId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // Rutas (líneas) - lectura pública permitida si la ruta es pública; escrituras sólo por admins
    match /routes/{routeId} {
      allow read: if resource.data.public == true || isSignedIn();

      allow create, update, delete: if isSignedIn() && isAdmin()
        && (request.resource.data.name is string || !('name' in request.resource.data))
        // aceptar geometry (map/encoded) o legacy coordinates/points
        && (
          request.resource.data.geometry is string ||
          request.resource.data.geometry is map ||
          request.resource.data.path is list ||
          request.resource.data.coordinates is list ||
          request.resource.data.points is list ||
          !('geometry' in request.resource.data)
        )
        && (
          !request.resource.data.keys().hasAny(['createdAt']) ||
          isTimestampOrString(request.resource.data.createdAt)
        );
    }

    // Vehículos: lectura autenticada; escritura por el conductor propietario o admin
    match /vehicles/{vehicleId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && (
        request.resource.data.driverId == request.auth.uid || isAdmin()
      )
      // validaciones mínimas
      && (request.resource.data.plate is string || !request.resource.data.keys().hasAny(['plate']))
      && (
        !request.resource.data.keys().hasAny(['vehicleInfo']) ||
        request.resource.data.vehicleInfo.model is string
      );

      allow delete: if isSignedIn() && (request.resource.data.driverId == request.auth.uid || isAdmin());
    }

    // Auditoría y telemetría: permitir a usuarios autenticados crear sus propios registros
    // en la modalidad Spark (free) validando que `userId` coincida con el UID autenticado.
    // Recomendación: cuando se disponga de custom claims o Cloud Functions, restringir a admins.
    match /audit_logs/{docId} {
      allow create: if isSignedIn()
        // el creador debe declarar su userId igual al uid autenticado
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.action is string
        && (!('affectedRouteIds' in request.resource.data) || request.resource.data.affectedRouteIds is list)
        && (!('note' in request.resource.data) || request.resource.data.note is string)
        && (!('timestamp' in request.resource.data) || request.resource.data.timestamp is timestamp);

      // Lectura: propietario o admins
      allow read: if isSignedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow update, delete: if false; // inmutables
    }

    match /telemetry/{docId} {
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.event is string
        && (!('routesCount' in request.resource.data) || request.resource.data.routesCount is number)
        && (!('durationMs' in request.resource.data) || request.resource.data.durationMs is number)
        && (!('timestamp' in request.resource.data) || request.resource.data.timestamp is timestamp);

      allow read: if isSignedIn() && isAdmin();
      allow update, delete: if false;
    }

    match /action_history/{docId} {
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.action is string
        && (!('count' in request.resource.data) || request.resource.data.count is number)
        && (!('timestamp' in request.resource.data) || request.resource.data.timestamp is timestamp);

      allow read: if isSignedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow update, delete: if false;
    }

  }
}
